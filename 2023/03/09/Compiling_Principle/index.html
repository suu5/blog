<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"suu5.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":true,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="以GCC编译器的视角，阐明C程序由源文件到可执行文件所经历的过程">
<meta property="og:type" content="article">
<meta property="og:title" content="Compiling Principle">
<meta property="og:url" content="https://suu5.github.io/blog/2023/03/09/Compiling_Principle/index.html">
<meta property="og:site_name" content="Suu&#39;s Blog">
<meta property="og:description" content="以GCC编译器的视角，阐明C程序由源文件到可执行文件所经历的过程">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://suu5.github.io/images/Compiling_Principle_images/Procedure%20of%20Compilation.png">
<meta property="article:published_time" content="2023-03-09T10:48:01.000Z">
<meta property="article:modified_time" content="2023-03-21T07:52:56.955Z">
<meta property="article:author" content="Suu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://suu5.github.io/images/Compiling_Principle_images/Procedure%20of%20Compilation.png">


<link rel="canonical" href="https://suu5.github.io/blog/2023/03/09/Compiling_Principle/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://suu5.github.io/blog/2023/03/09/Compiling_Principle/","path":"2023/03/09/Compiling_Principle/","title":"Compiling Principle"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Compiling Principle | Suu's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Suu's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Definition-of-ELF"><span class="nav-number">1.</span> <span class="nav-text">Definition of ELF</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Procedure-of-Compilation"><span class="nav-number">2.</span> <span class="nav-text">Procedure of Compilation</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Details-of-Procedure"><span class="nav-number">3.</span> <span class="nav-text">Details of Procedure</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Preprocess"><span class="nav-number">3.1.</span> <span class="nav-text">Preprocess</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Compile"><span class="nav-number">3.2.</span> <span class="nav-text">Compile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Assemble"><span class="nav-number">3.3.</span> <span class="nav-text">Assemble</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Link"><span class="nav-number">3.4.</span> <span class="nav-text">Link</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Structure-of-ELF"><span class="nav-number">4.</span> <span class="nav-text">Structure of ELF</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF-Header"><span class="nav-number">4.1.</span> <span class="nav-text">ELF Header</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Section"><span class="nav-number">4.2.</span> <span class="nav-text">Section</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Segment"><span class="nav-number">4.3.</span> <span class="nav-text">Segment</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Precedure-of-Linking"><span class="nav-number">5.</span> <span class="nav-text">Precedure of Linking</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Static-Linking"><span class="nav-number">5.1.</span> <span class="nav-text">Static Linking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Linking"><span class="nav-number">5.2.</span> <span class="nav-text">Dynamic Linking</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Suu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://suu5.github.io/blog/2023/03/09/Compiling_Principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Suu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suu's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Compiling Principle | Suu's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Compiling Principle
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-03-09 18:48:01" itemprop="dateCreated datePublished" datetime="2023-03-09T18:48:01+08:00">2023-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-21 15:52:56" itemprop="dateModified" datetime="2023-03-21T15:52:56+08:00">2023-03-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>以GCC编译器的视角，阐明C程序由源文件到可执行文件所经历的过程</p>
<span id="more"></span>
<h1 id="Definition-of-ELF"><a href="#Definition-of-ELF" class="headerlink" title="Definition of ELF"></a>Definition of ELF</h1><p>可执行可链接格式 (Executable and Linkable Format)，作为程序的二进制接口 (Application Binary Interface - ABI)，亦是COFF (Common File fotmat)格式变种  </p>
<p>ELF文件将作为编译产生的中间文件和最终目标文件，了解此文件格式有助于理解编译过程  </p>
<p>ELF文件 (亦称目标文件)分以下几种:</p>
<ul>
<li>Executable File (可执行文件):经过链接的可执行目标文件，亦称为程序</li>
<li>Relocatable File (可重定位文件):经过编译，未链接的目标文件，通常以”.o”为文件拓展名。与其他目标文件链接以构成动态链接库或可执行文件，通常是位置独立代码 (Position Independent Code - PIC)</li>
<li>Shared Object File (共享目标文件):动态链接库文件，在链接过程中与其他动态链接库文件或可重定位文件链接为新的目标文件，也可以在可执行文件运行前加载，链接到进程中作为运行代码的一部分</li>
<li>Core Dump File (核心转储文件):作为进程意外终止时进程地址空间的转储，用以辅佐gdb调试以查找程序崩溃的原因</li>
</ul>
<h1 id="Procedure-of-Compilation"><a href="#Procedure-of-Compilation" class="headerlink" title="Procedure of Compilation"></a>Procedure of Compilation</h1><ul>
<li>The Procedure<br><img src="/blog/../images/Compiling_Principle_images/Procedure%20of%20Compilation.png" alt="Procedure of Compilation"></li>
</ul>
<blockquote>
<p>hello.c</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hello.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Compiling with GCC in Bash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hello.c -o hello -save-temps --verbose</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The tree of the Directory</p>
</blockquote>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── hello</span><br><span class="line">├── hello.c</span><br><span class="line">├── hello.i</span><br><span class="line">├── hello.o</span><br><span class="line">└── hello.s</span><br></pre></td></tr></table></figure>

<h1 id="Details-of-Procedure"><a href="#Details-of-Procedure" class="headerlink" title="Details of Procedure"></a>Details of Procedure</h1><h2 id="Preprocess"><a href="#Preprocess" class="headerlink" title="Preprocess"></a>Preprocess</h2><blockquote>
<p>处理源代码中以’#’开始的预处理指令，将其转换后直接插入程序文本中，得到另外一个C程序，通常以”.i”作为文件拓展名<br>GCC命令中添加”-E”参数以单独执行预处理</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -E hello.c -o hello.i</span><br></pre></td></tr></table></figure>

<blockquote>
<p>hello.i</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hello.i</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">ftrylockfile</span> <span class="params">(FILE *__stream)</span> __<span class="title function_">attribute__</span> <span class="params">((__nothrow__ , __leaf__))</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">funlockfile</span> <span class="params">(FILE *__stream)</span> __<span class="title function_">attribute__</span> <span class="params">((__nothrow__ , __leaf__))</span>;</span><br><span class="line"># <span class="number">885</span> <span class="string">&quot;/usr/include/stdio.h&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __uflow (FILE *);</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __overflow (FILE *, <span class="type">int</span>);</span><br><span class="line"># <span class="number">902</span> <span class="string">&quot;/usr/include/stdio.h&quot;</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"># <span class="number">2</span> <span class="string">&quot;hello.c&quot;</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"># <span class="number">2</span> <span class="string">&quot;hello.c&quot;</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h2><blockquote>
<p>将上述预处理文件进行一系列词法分析、语法分析、语义分析以及优化，最终生成汇编代码，以”.s”作为文件拓展名<br>GCC命令中添加”-S”参数以对源文件或预处理文件执行编译</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对预处理文件执行命令</span></span><br><span class="line">gcc -S hello.i -o hello.s</span><br></pre></td></tr></table></figure>
<p>Use the option to make Assembly code clear</p>
<blockquote>
<p>GCC命令中添加编译选项”-masm&#x3D;intel -fno-asynchronous-unwind-tables”以提高代码可读性</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -S hello.i -o hello.s -masm=intel -fno-asynchronous-unwind-tables</span><br></pre></td></tr></table></figure>

<blockquote>
<p>hello.s</p>
</blockquote>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">	.file	&quot;hello.c&quot;</span><br><span class="line">	.intel_syntax noprefix</span><br><span class="line">	.text</span><br><span class="line">	.section	.rodata</span><br><span class="line">.LC0:</span><br><span class="line">	.string	&quot;Hello World&quot;</span><br><span class="line">	.text</span><br><span class="line">	.globl	main</span><br><span class="line">	.type	main, @function</span><br><span class="line">main:</span><br><span class="line">	endbr64</span><br><span class="line">	push	rbp</span><br><span class="line">	mov	rbp, rsp</span><br><span class="line">	lea	rax, .LC0[rip]</span><br><span class="line">	mov	rdi, rax</span><br><span class="line">	call	puts@PLT</span><br><span class="line">	mov	eax, 0</span><br><span class="line">	pop	rbp</span><br><span class="line">	ret</span><br><span class="line">	.size	main, .-main</span><br><span class="line">	.ident	&quot;GCC: (Ubuntu 11.3.0-1ubuntu1~22.04) 11.3.0&quot;</span><br><span class="line">	.section	.note.GNU-stack,&quot;&quot;,@progbits</span><br><span class="line">	.section	.note.gnu.property,&quot;a&quot;</span><br><span class="line">	.align 8</span><br><span class="line">	.long	1f - 0f</span><br><span class="line">	.long	4f - 1f</span><br><span class="line">	.long	5</span><br><span class="line">0:</span><br><span class="line">	.string	&quot;GNU&quot;</span><br><span class="line">1:</span><br><span class="line">	.align 8</span><br><span class="line">	.long	0xc0000002</span><br><span class="line">	.long	3f - 2f</span><br><span class="line">2:</span><br><span class="line">	.long	0x3</span><br><span class="line">3:</span><br><span class="line">	.align 8</span><br><span class="line">4:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Assemble"><a href="#Assemble" class="headerlink" title="Assemble"></a>Assemble</h2><blockquote>
<p>汇编器依据汇编指令与机器指令的对照表进行翻译，将汇编文件汇编成目标文件，以”.o”作为文件拓展名<br>GCC命令中添加”-c”参数以执行汇编处理  </p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c hello.s -o hello.o</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Object File is generated by Assembler (Relocatable File but Unreadble)<br>Use the command to read the unreadable</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -sd hello.o -M intel</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The Content of the Unreadable File</p>
</blockquote>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">hello.o：     文件格式 elf64-x86-64</span><br><span class="line"></span><br><span class="line">Contents of section .text:</span><br><span class="line"> 0000 f30f1efa 554889e5 488d0500 00000048  ....UH..H......H</span><br><span class="line"> 0010 89c7e800 000000b8 00000000 5dc3      ............].  </span><br><span class="line">Contents of section .rodata:</span><br><span class="line"> 0000 48656c6c 6f20576f 726c6400           Hello World.    </span><br><span class="line">Contents of section .comment:</span><br><span class="line"> 0000 00474343 3a202855 62756e74 75203131  .GCC: (Ubuntu 11</span><br><span class="line"> 0010 2e332e30 2d317562 756e7475 317e3232  .3.0-1ubuntu1~22</span><br><span class="line"> 0020 2e303429 2031312e 332e3000           .04) 11.3.0.    </span><br><span class="line">Contents of section .note.gnu.property:</span><br><span class="line"> 0000 04000000 10000000 05000000 474e5500  ............GNU.</span><br><span class="line"> 0010 020000c0 04000000 03000000 00000000  ................</span><br><span class="line">Contents of section .eh_frame:</span><br><span class="line"> 0000 14000000 00000000 017a5200 01781001  .........zR..x..</span><br><span class="line"> 0010 1b0c0708 90010000 1c000000 1c000000  ................</span><br><span class="line"> 0020 00000000 1e000000 00450e10 8602430d  .........E....C.</span><br><span class="line"> 0030 06550c07 08000000                    .U......        </span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;main&gt;:</span><br><span class="line">   0:   f3 0f 1e fa             endbr64 </span><br><span class="line">   4:   55                      push   rbp</span><br><span class="line">   5:   48 89 e5                mov    rbp,rsp</span><br><span class="line">   8:   48 8d 05 00 00 00 00    lea    rax,[rip+0x0]        # f &lt;main+0xf&gt;</span><br><span class="line">   f:   48 89 c7                mov    rdi,rax</span><br><span class="line">  12:   e8 00 00 00 00          call   17 &lt;main+0x17&gt;</span><br><span class="line">  17:   b8 00 00 00 00          mov    eax,0x0</span><br><span class="line">  1c:   5d                      pop    rbp</span><br><span class="line">  1d:   c3                      ret</span><br></pre></td></tr></table></figure>

<h2 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h2><blockquote>
<p>最后一个阶段是链接，分为静态链接或动态链接。GCC默认为动态链接<br>链接阶段将涉及目标文件与其他可重定位文件或依赖库的链接，生成可执行文件，确定文件地址和内存空间的分配，符号绑定，重定位等操作<br>GCC命令中添加”-static”可指定静态链接</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#file will be linked with Static linking instead of Dynamic linking, but Dynamic link is default</span></span><br><span class="line">gcc hello.o -o hello -static</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Executable file is generated by Linker (Executable file is unreadable too)<br>Use the command to read the unreadable</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -sd hello_static -M intel</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The part of Executable File by static linking</p>
</blockquote>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">0000000000497650 &lt;free_mem&gt;:</span><br><span class="line">  497650:       f3 0f 1e fa             endbr64 </span><br><span class="line">  497654:       48 8b 3d 7d 52 03 00    mov    rdi,QWORD PTR [rip+0x3527d]        # 4cc8d8 &lt;__printf_modifier_table&gt;</span><br><span class="line">  49765b:       48 85 ff                test   rdi,rdi</span><br><span class="line">  49765e:       74 4f                   je     4976af &lt;free_mem+0x5f&gt;</span><br><span class="line">  497660:       55                      push   rbp</span><br><span class="line">  497661:       31 ed                   xor    ebp,ebp</span><br><span class="line">  497663:       53                      push   rbx</span><br><span class="line">  497664:       48 83 ec 08             sub    rsp,0x8</span><br><span class="line">  497668:       0f 1f 84 00 00 00 00    nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">  49766f:       00 </span><br><span class="line">  497670:       48 8b 1c 2f             mov    rbx,QWORD PTR [rdi+rbp*1]</span><br><span class="line">  497674:       48 85 db                test   rbx,rbx</span><br><span class="line">  497677:       74 1e                   je     497697 &lt;free_mem+0x47&gt;</span><br><span class="line">  497679:       0f 1f 80 00 00 00 00    nop    DWORD PTR [rax+0x0]</span><br><span class="line">  497680:       48 89 df                mov    rdi,rbx</span><br><span class="line">  497683:       48 8b 1b                mov    rbx,QWORD PTR [rbx]</span><br><span class="line">  497686:       e8 15 24 f8 ff          call   419aa0 &lt;__free&gt;</span><br><span class="line">  49768b:       48 85 db                test   rbx,rbx</span><br><span class="line">  49768e:       75 f0                   jne    497680 &lt;free_mem+0x30&gt;</span><br><span class="line">  497690:       48 8b 3d 41 52 03 00    mov    rdi,QWORD PTR [rip+0x35241]        # 4cc8d8 &lt;__printf_modifier_table&gt;</span><br><span class="line">  497697:       48 83 c5 08             add    rbp,0x8</span><br><span class="line">  49769b:       48 81 fd f8 07 00 00    cmp    rbp,0x7f8</span><br><span class="line">  4976a2:       75 cc                   jne    497670 &lt;free_mem+0x20&gt;</span><br><span class="line">  4976a4:       48 83 c4 08             add    rsp,0x8</span><br><span class="line">  4976a8:       5b                      pop    rbx</span><br><span class="line">  4976a9:       5d                      pop    rbp</span><br><span class="line">  4976aa:       e9 f1 23 f8 ff          jmp    419aa0 &lt;__free&gt;</span><br><span class="line">  4976af:       c3                      ret    </span><br><span class="line"></span><br><span class="line">Disassembly of section .fini:</span><br><span class="line"></span><br><span class="line">00000000004976b0 &lt;_fini&gt;:</span><br><span class="line">  4976b0:       f3 0f 1e fa             endbr64 </span><br><span class="line">  4976b4:       48 83 ec 08             sub    rsp,0x8</span><br><span class="line">  4976b8:       48 83 c4 08             add    rsp,0x8</span><br><span class="line">  4976bc:       c3                      ret  </span><br></pre></td></tr></table></figure>

<h1 id="Structure-of-ELF"><a href="#Structure-of-ELF" class="headerlink" title="Structure of ELF"></a>Structure of ELF</h1><p>审视目标文件的结构时，可通过两种视角来理解，一种是链接视角，以节 (Section)来划分；另一种是运行视角，以段 (Segment)来划分  </p>
<p>不同的ELF文件模型简化后有几个共同特征，其中一个特征是ELF文件头 (ELF Header)  </p>
<h2 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h2><blockquote>
<p>ELF文件头如其名，它位于目标文件最开始的位置，包含描述整个文件的一些基本信息:ELF文件类型、版本信息、目标机器、程序入口、段表和节表的位置和长度<br>ELF文件头存在一个明显的魔术字符 (7f 45 4c 46)，表示字符串”\177ELF”，当该文件映射于内存中时，可以由此特征确定文件的映射地址<br>Use the command to read the ELF Header of the File</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Show the message from Relocatable File</span></span><br><span class="line">readelf -h hello.o</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ELF 头：</span><br><span class="line">  Magic：   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  类别:                              ELF64</span><br><span class="line">  数据:                              2 补码，小端序 (little endian)</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI 版本:                          0</span><br><span class="line">  类型:                              REL (可重定位文件)</span><br><span class="line">  系统架构:                          Advanced Micro Devices X86-64</span><br><span class="line">  版本:                              0x1</span><br><span class="line">  入口点地址：               0x0</span><br><span class="line">  程序头起点：          0 (bytes into file)</span><br><span class="line">  Start of section headers:          600 (bytes into file)</span><br><span class="line">  标志：             0x0</span><br><span class="line">  Size of this header:               64 (bytes)</span><br><span class="line">  Size of program headers:           0 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         14</span><br><span class="line">  Section header string table index: 13</span><br></pre></td></tr></table></figure>
<p>Use the command to read the ELF Header of the File</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Show the message from Position-Independent Executable File</span></span><br><span class="line">readelf -h hello</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ELF 头：</span><br><span class="line">  Magic：   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  类别:                              ELF64</span><br><span class="line">  数据:                              2 补码，小端序 (little endian)</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI 版本:                          0</span><br><span class="line">  类型:                              DYN (Position-Independent Executable file)</span><br><span class="line">  系统架构:                          Advanced Micro Devices X86-64</span><br><span class="line">  版本:                              0x1</span><br><span class="line">  入口点地址：               0x1060</span><br><span class="line">  程序头起点：          64 (bytes into file)</span><br><span class="line">  Start of section headers:          13976 (bytes into file)</span><br><span class="line">  标志：             0x0</span><br><span class="line">  Size of this header:               64 (bytes)</span><br><span class="line">  Size of program headers:           56 (bytes)</span><br><span class="line">  Number of program headers:         13</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         31</span><br><span class="line">  Section header string table index: 30</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从字节的角度来理解ELF文件头 (其结构与C语言定义一一对应)，这里只关注其在64位系统中的定义，具体字段的意义可对照上文理解</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//The definition of ELF Header on 64bit system</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT]; <span class="comment">//16 B (B for bytes)</span></span><br><span class="line">        Elf64_Half      e_type; <span class="comment">// 2 B</span></span><br><span class="line">        Elf64_Half      e_machine; <span class="comment">// 2 B</span></span><br><span class="line">        Elf64_Word      e_version; <span class="comment">// 4 B</span></span><br><span class="line">        Elf64_Addr      e_entry; <span class="comment">// 8 B</span></span><br><span class="line">        Elf64_Off       e_phoff; <span class="comment">// 8 B</span></span><br><span class="line">        Elf64_Off       e_shoff; <span class="comment">// 8 B</span></span><br><span class="line">        Elf64_Word      e_flags; <span class="comment">// 4 B</span></span><br><span class="line">        Elf64_Half      e_ehsize; <span class="comment">// 2 B</span></span><br><span class="line">        Elf64_Half      e_phentsize; <span class="comment">// 2 B</span></span><br><span class="line">        Elf64_Half      e_phnum; <span class="comment">// 2 B</span></span><br><span class="line">        Elf64_Half      e_shentsize; <span class="comment">// 2 B</span></span><br><span class="line">        Elf64_Half      e_shnum; <span class="comment">// 2 B</span></span><br><span class="line">        Elf64_Half      e_shstrndx; <span class="comment">// 2 B</span></span><br><span class="line">&#125; Elf64_Ehdr;  <span class="comment">// total size = 64 B</span></span><br></pre></td></tr></table></figure>

<h2 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h2><blockquote>
<p>将指令和数据分开存放能保证其安全性。从链接的角度看，指令和数据分别存放在各自对应的节中。通常目标文件都会包含三个节，分别是  </p>
</blockquote>
<ul>
<li>.text(代码):保存可执行的机器指令，其所处内存的权限为可执行、可读</li>
<li>.data(数据):保存已初始化的全局变量和局部静态变量，其所处内存的权限为可读写</li>
<li>.bss(Block Started by Symbolsegment):保存未初始化的全局变量和局部静态变量，其所处内存的权限为可读写</li>
</ul>
<blockquote>
<p>节的信息保存在节头表 (Section Header Table)  </p>
</blockquote>
<ul>
<li>节头表的位置记录在文件头的e_shoff域 (见上文)中</li>
<li>节头表记录了各个节的名字、长度、偏移、读写权限等信息</li>
</ul>
<p>Use the command to read Section header table of the Object File</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -S hello.o</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">There are 14 section headers, starting at offset 0x258:</span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [号] 名称              类型             地址              偏移量</span><br><span class="line">       大小              全体大小          旗标   链接   信息   对齐</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000001e  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000198</span><br><span class="line">       0000000000000030  0000000000000018   I      11     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  0000005e</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  0000005e</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 5] .rodata           PROGBITS         0000000000000000  0000005e</span><br><span class="line">       000000000000000c  0000000000000000   A       0     0     1</span><br><span class="line">  [ 6] .comment          PROGBITS         0000000000000000  0000006a</span><br><span class="line">       000000000000002c  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 7] .note.GNU-stack   PROGBITS         0000000000000000  00000096</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 8] .note.gnu.pr[...] NOTE             0000000000000000  00000098</span><br><span class="line">       0000000000000020  0000000000000000   A       0     0     8</span><br><span class="line">  [ 9] .eh_frame         PROGBITS         0000000000000000  000000b8</span><br><span class="line">       0000000000000038  0000000000000000   A       0     0     8</span><br><span class="line">  [10] .rela.eh_frame    RELA             0000000000000000  000001c8</span><br><span class="line">       0000000000000018  0000000000000018   I      11     9     8</span><br><span class="line">  [11] .symtab           SYMTAB           0000000000000000  000000f0</span><br><span class="line">       0000000000000090  0000000000000018          12     4     8</span><br><span class="line">  [12] .strtab           STRTAB           0000000000000000  00000180</span><br><span class="line">       0000000000000013  0000000000000000           0     0     1</span><br><span class="line">  [13] .shstrtab         STRTAB           0000000000000000  000001e0</span><br><span class="line">       0000000000000074  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  D (mbind), l (large), p (processor specific)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从字节的角度来理解节头表 (其结构与C语言定义一一对应)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//The definition of Section Header Table on 64bit system</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	Elf64_Word	sh_name; <span class="comment">// 4 B (B for bytes)</span></span><br><span class="line">	Elf64_Word	sh_type; <span class="comment">// 4 B</span></span><br><span class="line">	Elf64_Xword	sh_flags; <span class="comment">// 8 B</span></span><br><span class="line">	Elf64_Addr	sh_addr; <span class="comment">// 8 B</span></span><br><span class="line">	Elf64_Off	sh_offset; <span class="comment">// 8 B</span></span><br><span class="line">	Elf64_Xword	sh_size; <span class="comment">// 8 B</span></span><br><span class="line">	Elf64_Word	sh_link; <span class="comment">// 4 B</span></span><br><span class="line">	Elf64_Word	sh_info; <span class="comment">// 4 B</span></span><br><span class="line">	Elf64_Xword	sh_addralign; <span class="comment">// 8 B</span></span><br><span class="line">	Elf64_Xword	sh_entsize; <span class="comment">// 8 B</span></span><br><span class="line">&#125; Elf64_Shdr; <span class="comment">// total size: 64 B</span></span><br></pre></td></tr></table></figure>

<p>补充一些常见的节  </p>
<ul>
<li><p>.strtab (String Table):字符串表</p>
<blockquote>
<p>包含了以”NULL”结尾的字符序列，用来表示节名和符号名。引用字符串时秩序给出字符序列在表中的偏移<br>Use the command to read the String of the Object File</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -x .strtab hello.o</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">“.strtab”节的十六进制输出：</span><br><span class="line">  0x00000000 0068656c 6c6f2e63 006d6169 6e007075 .hello.c.main.pu</span><br><span class="line">  0x00000010 747300                              ts.</span><br></pre></td></tr></table></figure>
</li>
<li><p>.symtab (Symbol Table):符号表</p>
<blockquote>
<p>记录了目标文件中所用到的所有符号信息，通常分为”.dynsym”和”.symtab”，前者是后者的子集。”.dynsym”保存了引用外部文件的符号，只能在运行时被解析;”.symtab”还保存本地符号</p>
<p>每个符号都有一个对应的符号值 (Symbol Value)，对于变量和函数，符号值就是其地址<br>Use the command to read the Symbol of the Object File</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -s hello.o</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Symbol table &#x27;.symtab&#x27; contains 6 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS hello.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 .rodata</span><br><span class="line">     4: 0000000000000000    30 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">     5: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND puts</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Segment"><a href="#Segment" class="headerlink" title="Segment"></a>Segment</h2><blockquote>
<p>段包含了一个或多个节，相当于对文件中节的分组</p>
<p>进行内存映射时，系统通过对不同权限 (读、写、执行)的节进行分组，来达到节省空间资源的目的  </p>
</blockquote>
<blockquote>
<p>当运行一个可执行文件时，首先需要将该文件和动态链接库装载到进程空间中，形成进程镜像，每个进程拥有独立的虚拟地址空间</p>
<p>这个空间的布局记录在段头表中的程序头 (Program Header)，ELF文件头的”e_phoff”域给出段头表位置</p>
</blockquote>
<p>Use the command to read Program Header and the Segment mapping of the Executable File</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readelf -l hello</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">Elf 文件类型为 DYN (Position-Independent Executable file)</span><br><span class="line">Entry point 0x1060</span><br><span class="line">There are 13 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">程序头：</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  PHDR           0x0000000000000040 0x0000000000000040 0x0000000000000040</span><br><span class="line">                 0x00000000000002d8 0x00000000000002d8  R      0x8</span><br><span class="line">  INTERP         0x0000000000000318 0x0000000000000318 0x0000000000000318</span><br><span class="line">                 0x000000000000001c 0x000000000000001c  R      0x1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line">  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">                 0x0000000000000628 0x0000000000000628  R      0x1000</span><br><span class="line">  LOAD           0x0000000000001000 0x0000000000001000 0x0000000000001000</span><br><span class="line">                 0x0000000000000175 0x0000000000000175  R E    0x1000</span><br><span class="line">  LOAD           0x0000000000002000 0x0000000000002000 0x0000000000002000</span><br><span class="line">                 0x00000000000000f4 0x00000000000000f4  R      0x1000</span><br><span class="line">  LOAD           0x0000000000002db8 0x0000000000003db8 0x0000000000003db8</span><br><span class="line">                 0x0000000000000258 0x0000000000000260  RW     0x1000</span><br><span class="line">  DYNAMIC        0x0000000000002dc8 0x0000000000003dc8 0x0000000000003dc8</span><br><span class="line">                 0x00000000000001f0 0x00000000000001f0  RW     0x8</span><br><span class="line">  NOTE           0x0000000000000338 0x0000000000000338 0x0000000000000338</span><br><span class="line">                 0x0000000000000030 0x0000000000000030  R      0x8</span><br><span class="line">  NOTE           0x0000000000000368 0x0000000000000368 0x0000000000000368</span><br><span class="line">                 0x0000000000000044 0x0000000000000044  R      0x4</span><br><span class="line">  GNU_PROPERTY   0x0000000000000338 0x0000000000000338 0x0000000000000338</span><br><span class="line">                 0x0000000000000030 0x0000000000000030  R      0x8</span><br><span class="line">  GNU_EH_FRAME   0x0000000000002010 0x0000000000002010 0x0000000000002010</span><br><span class="line">                 0x0000000000000034 0x0000000000000034  R      0x4</span><br><span class="line">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">                 0x0000000000000000 0x0000000000000000  RW     0x10</span><br><span class="line">  GNU_RELRO      0x0000000000002db8 0x0000000000003db8 0x0000000000003db8</span><br><span class="line">                 0x0000000000000248 0x0000000000000248  R      0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  段节...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br><span class="line">   02     .interp .note.gnu.property .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt </span><br><span class="line">   03     .init .plt .plt.got .plt.sec .text .fini </span><br><span class="line">   04     .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   05     .init_array .fini_array .dynamic .got .data .bss </span><br><span class="line">   06     .dynamic </span><br><span class="line">   07     .note.gnu.property </span><br><span class="line">   08     .note.gnu.build-id .note.ABI-tag </span><br><span class="line">   09     .note.gnu.property </span><br><span class="line">   10     .eh_frame_hdr </span><br><span class="line">   11     </span><br><span class="line">   12     .init_array .fini_array .dynamic .got</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从字节的角度来理解程序头 (其结构与C语言定义一一对应)，具体字段意义可对照上文程序头内容理解</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//The definition of Program Segment Header</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word    p_type;<span class="comment">/* Segment type */</span></span><br><span class="line">  Elf64_Word    p_flags;<span class="comment">/* Segment flags */</span></span><br><span class="line">  Elf64_Off     p_offset;<span class="comment">/* Segment file offset */</span></span><br><span class="line">  Elf64_Addr    p_vaddr;<span class="comment">/* Segment virtual address */</span></span><br><span class="line">  Elf64_Addr    p_paddr;<span class="comment">/* Segment physical address */</span></span><br><span class="line">  Elf64_Xword   p_filesz;<span class="comment">/* Segment size in file */</span></span><br><span class="line">  Elf64_Xword   p_memsz;<span class="comment">/* Segment size in memory */</span></span><br><span class="line">  Elf64_Xword   p_align;<span class="comment">/* Segment alignment */</span></span><br><span class="line">&#125; Elf64_Phdr;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对程序头中”p_type”字段的解释</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Legal values for p_type (segment type).  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_NULL     0		 <span class="comment">/* Program header table entry unused */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOAD     1		 <span class="comment">/* Loadable program segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_DYNAMIC  2		 <span class="comment">/* Dynamic linking information */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_INTERP   3		 <span class="comment">/* Program interpreter */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_NOTE     4		 <span class="comment">/* Auxiliary information */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_SHLIB    5		 <span class="comment">/* Reserved */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_PHDR     6		 <span class="comment">/* Entry for header table itself */</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>介绍几个常见的段</p>
</blockquote>
<ul>
<li>PT_LOAD (Segemet &#x3D; 1)<blockquote>
<p>通常可执行文件至少有一个该段，用于描述可装载的节，而动态链接的可执行文件包含两个该段，分别存放”.data”和”.text”两个节</p>
</blockquote>
</li>
<li>PY_DYNAMIC (Segment &#x3D; 2)<blockquote>
<p>包含了动态链接器所必须的信息，如共享库列表、GOT表和重定位表</p>
</blockquote>
</li>
<li>PT_INTERP (Segment &#x3D; 3)<blockquote>
<p>将位置和大小信息存放在一个字符串中，描述程序解释器位置</p>
</blockquote>
</li>
<li>PT_NOTE (Segment &#x3D; 4)<blockquote>
<p>保存了系统相关的附加信息，但这不是程序运行所必须的内容</p>
</blockquote>
</li>
<li>PT_PHDR (Segment &#x3D; 6)<blockquote>
<p>保存程序头表本身的位置和大小</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>诚然，只有段空间的进程内存并不完备，其中还应该包含栈 (Stack)、堆 (Heap)、VDSO 等空间，这些空间同样需要通过权限来进行访问控制，保证程序运行时安全  </p>
</blockquote>
<h1 id="Precedure-of-Linking"><a href="#Precedure-of-Linking" class="headerlink" title="Precedure of Linking"></a>Precedure of Linking</h1><p>需要两个或多个不同的目标文件组合成可执行文件，需要对其进行链接 (Linking)。链接由链接器 (Linker)完成，根据发生时间的不同，链接又可分为如下几种:</p>
<ul>
<li>Compile time - 编译时链接</li>
<li>Load time - 加载时链接</li>
<li>Run time - 运行时链接</li>
</ul>
<blockquote>
<p>链接器的工作是将不同的目标文件中相同属性的节合并为一个节，具体流程如下:</p>
</blockquote>
<ol>
<li>分析各个节的长度、属性和偏移</li>
<li>由输入文件中符号表的符号定义与符号引用统一生成全局符号表</li>
<li>通过读取输入文件的各类信息对符号进行解析，重定位 (相似节合并)</li>
</ol>
<blockquote>
<p>以上步骤完成后，程序中的每条指令和全局变量就拥有唯一的运行时内存地址  </p>
</blockquote>
<h2 id="Static-Linking"><a href="#Static-Linking" class="headerlink" title="Static Linking"></a>Static Linking</h2><p>符号概念</p>
<blockquote>
<p>符号 :函数名、全局变量名、静态变量名、节名、段名等<br>符号分为三种类型:</p>
<ol>
<li>全局符号:定义在某一模块，能被外部目标文件引用 (包括非static 的函数、非static 的全局变量)  </li>
<li>外部符号:在目标文件中存在其引用但无定义  </li>
<li>局部符号:其定义和引用均在当前目标文件 (包括带static 的函数和全局变量)</li>
</ol>
<p>注:</p>
<ul>
<li>在当前目标文件所引用的全部符号将记录在符号表中</li>
<li>局部变量不是局部符号，局部变量存在于栈空间或寄存器上，而非段空间，故局部变量的信息不会记录在符号表中</li>
<li>本地的static变量存在于段空间上 (静态数据区)</li>
<li>在目标文件中出现无定义的符号引用，称为外部引用</li>
</ul>
</blockquote>
<p>链接器构造可执行文件将会完成两个工作:  </p>
<ol>
<li>Symbol Resolution (符号解析)<blockquote>
<p>将每个目标文件中引用的符号与某个目标文件中定义的符号关联<br>符号的定义意味其相关信息存在于内存中，符号值对应该内存地址</p>
</blockquote>
</li>
<li>Relocation (重定位)<blockquote>
<p>符号解析完成后进行重定位操作:</p>
</blockquote>
</li>
<li>合并相同的节<blockquote>
<p>如:所有目标文件中的”.text”节合并为可执行文件中的”.text”节</p>
</blockquote>
</li>
<li>对符号定义进行重定位<blockquote>
<p>确定新节中所有定义符号在虚拟内存空间中的地址<br>如:为函数确定入口首地址，进而确定函数中指令的地址</p>
</blockquote>
</li>
<li>对符号引用进行重定位<blockquote>
<p>如:修改”.text”和”.data”中对每个符号的引用<br>需要配合”.rel_data”和”.rel_text”中保存的重定位信息</p>
</blockquote>
</li>
</ol>
<h2 id="Dynamic-Linking"><a href="#Dynamic-Linking" class="headerlink" title="Dynamic Linking"></a>Dynamic Linking</h2><p>动态链接是为解决静态链接浪费空间资源的问题，解决的思路是把链接的过程推迟到运行时进行</p>
<blockquote>
<p>GCC默认使用动态链接编译，通过如下命令将源文件编译为共享库文件<br>其中参数”-shared”表示生成共享库，”-fpic”表示生成与位置无关的代码</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc func.c -shared -fpic -o func.so</span><br></pre></td></tr></table></figure>
<blockquote>
<p>然后在将其与其他目标文件链接</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.o ./func.so -o main_dy</span><br></pre></td></tr></table></figure>
<p>此时可执行文件顺利执行</p>
<blockquote>
<p>如果此时删除共享库文件，再执行可执行文件，将会产生错误</p>
</blockquote>
<figure class="highlight plaintext"><figcaption><span>text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./main_dy: error while loading shared libraries: ./func.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>
<p>动态链接共享相同的代码，也即共享库的指令内容不会改变，但当共享库文件涉及到访问其他文件的数据或者调用其他文件的函数，就不得不在装载其他文件时修改共享库文件中对这二者的地址信息</p>
<p>GOT (Global Offset Table)<br>全局偏移量表</p>
<blockquote>
<p>里面存放跨模块数据的地址，可以在装载时动态填入，共享对象指令中跨文件数据的访问可以通过GOT的指针间接访问</p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2023/03/01/Simple-Implementation-of-Stack/" rel="prev" title="Simple Implementation of Stack">
                  <i class="fa fa-chevron-left"></i> Simple Implementation of Stack
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2023/04/07/First-sight-of-Golang/" rel="next" title="First_sight_of_Golang">
                  First_sight_of_Golang <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Suu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/schemes/muse.js"></script><script src="/blog/js/next-boot.js"></script>

  




  





</body>
</html>
